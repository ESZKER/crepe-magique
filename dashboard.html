<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title> Orders Dashboard</title>
<style>
body {
  font-family: "Poppins", sans-serif;
  background-color: #fffaf7;
  color: #4b2e2b;
  margin: 0;
  padding: 0;
}
header {
  background-color: #d7b89c;
  padding: 10px 50px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
header h1 { margin: 0; font-size: 1.5em; }
button {
  background-color: #4b2e2b;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
  font-family: inherit;
}
main { padding: 20px; }
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}
th, td {
  border: 1px solid #d7b89c;
  padding: 10px;
  text-align: left;
  vertical-align: top;
}
th { background-color: #7a4f4b; color: white; }
tr:nth-child(even) { background: #f8f1ec; }
tr.completed { text-decoration: line-through; opacity: 0.6; }
.action-btn {
  background: #c9a07b;
  color: white;
  border: none;
  border-radius: 5px;
  padding: 5px 8px;
  cursor: pointer;
}
.review-section {
  margin-top: 50px;
  background-color: #fff2e8;
  border-top: 2px solid #d7b89c;
  padding: 20px;
  border-radius: 10px;
}
.review-section h2 { margin-top: 0; }
.review {
  background-color: #fff;
  border: 1px solid #d7b89c;
  border-radius: 8px;
  padding: 10px;
  margin: 10px 0;
}
.review button {
  background-color: #b84f3c;
  padding: 4px 8px;
  font-size: 0.8em;
}
#revenueTable { margin-top: 30px; border: 1px solid #d7b89c; }
#revenueTable th, #revenueTable td {
  border: 1px solid #d7b89c;
  padding: 8px;
}
#revenueTable th { background-color: #7a4f4b; color: white; }
#revenueTable td { background-color: #fdf5f0; color: #4b2e2b; }
@media (max-width:600px){
  table, th, td { font-size: 0.85em; }
}
</style>
</head>
<body>
<header>
  <h1>Crepe Magique – Orders Dashboard</h1>
  <div>
    <button id="backBtn">⬅ Back to Menu</button>
    <button id="clearOrders">Clear All Orders</button>
    <button id="resetStockBtn" style="background:#8b5e3c;">Reset Stock</button>
  </div>
</header>

<main>
  <!-- Orders Table -->
  <table id="ordersTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Year/Staff</th>
        <th>Order</th>
        <th>Total (៛)</th>
        <th>Order Time</th>
        <th>Delivery Time</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Revenue Summary -->
  <section class="review-section">
    <h2>Revenue Summary</h2>
    <table id="revenueTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Total Revenue (៛)</th>
          <th>Items Sold</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Customer Reviews -->
  <section class="review-section">
    <h2>Customer Reviews (<span id="reviewCount">0</span>)</h2>
    <div id="reviewsList"></div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB6DxMKy1y28t4xtvw0SMcx3K4pivB7grw",
    authDomain: "crepe-magique.firebaseapp.com",
    projectId: "crepe-magique",
    storageBucket: "crepe-magique.firebasestorage.app",
    messagingSenderId: "175773010517",
    appId: "1:175773010517:web:170168816a70efa825a2dc",
    measurementId: "G-J3S8GPYLMD"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  window.db = db;
  window.ref = ref;
  window.push = push;
</script>

<script>
// --- Utility ---
function safeParse(json, fallback) {
  try { return JSON.parse(json); } catch { return fallback; }
}

// --- Load Orders from Firebase ---
function loadOrders() {
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Loading...</td></tr>';

  const db = getDatabase();
  const ordersRef = ref(db, 'orders');

  onValue(ordersRef, (snapshot) => {
    const data = snapshot.val();
    tbody.innerHTML = '';

    if (!data) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No orders yet.</td></tr>';
      return;
    }

    const orders = Object.entries(data);
    orders.forEach(([key, order], index) => {
      const tr = document.createElement("tr");

      const orderDetails = Array.isArray(order.items)
        ? order.items.map(item => {
            const toppings = item.toppings?.length ? `<small>+ ${item.toppings.join(", ")}</small>` : "";
            return `${item.item} ×${item.quantity}${toppings}`;
          }).join("<br>")
        : "";

      tr.innerHTML = `
        <td>${order.name || ""}</td>
        <td>${order.phone || "—"}</td>
        <td>${order.year || ""}</td>
        <td>${orderDetails}</td>
        <td>${(order.total || 0).toLocaleString()}</td>
        <td>${order.time || ""}</td>
        <td>${order.pickupTime || "—"}</td>
        <td>
          <button class="action-btn" onclick="markComplete('${key}')">Done</button>
          <button class="action-btn" style="background:#b84f3c;" onclick="deleteOrder('${key}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// --- Mark Order Complete ---
function markComplete(orderId) {
  const db = getDatabase();
  const orderRef = ref(db, 'orders/' + orderId);
  update(orderRef, { completed: true });
}

// --- Delete Order ---
function deleteOrder(orderId) {
  if (!confirm("Delete this order?")) return;
  const db = getDatabase();
  const orderRef = ref(db, 'orders/' + orderId);
  remove(orderRef);
}

// --- Clear Orders + Record Revenue  ---
document.getElementById("clearOrders").addEventListener("click", () => {
  const orders = safeParse(localStorage.getItem("orders"), []);
  if (!orders.length) {
    alert("No orders to clear.");
    return;
  }

  if (!confirm("Record today’s revenue and clear all orders?")) return;

  const today = new Date().toLocaleDateString();
  let total = 0;
  const soldItems = {};

  orders.forEach(o => {
    if (!Array.isArray(o.items)) return;

    o.items.forEach(i => {
      const basePrice = Number(i.price) || 0;
      const qty = Number(i.quantity) || 0;
      let toppingCost = 0;

      // Calculate topping price 
      if (Array.isArray(i.toppings) && i.toppings.length) {
        i.toppings.forEach(t => {
          // Extract numbers in parentheses 
          const match = String(t).match(/\d+/);
          const extra = match ? Number(match[0]) : 0;
          toppingCost += extra;
        });
      }

      const itemTotal = (basePrice + toppingCost) * qty;
      total += itemTotal;

      const itemName = i.item || "Unknown Item";
      soldItems[itemName] = (soldItems[itemName] || 0) + qty;

      if (Array.isArray(i.toppings)) {
        i.toppings.forEach(t => {
          const toppingLabel = String(t).replace(/\s*\(៛?\d+\)/, ""); 
          const combo = `${itemName} (+${toppingLabel})`;
          soldItems[combo] = (soldItems[combo] || 0) + qty;
        });
      }
    });
  });

// --- Update and preserve revenue history ---
const existingLog = safeParse(localStorage.getItem("revenueLog"), {});
const updatedLog = { ...existingLog };

// If this date already exists, merge new totals and items
if (updatedLog[today]) {
  updatedLog[today].total = (updatedLog[today].total || 0) + total;

  for (const [item, qty] of Object.entries(soldItems)) {
    updatedLog[today].items[item] = (updatedLog[today].items[item] || 0) + qty;
  }
} else {
  // Otherwise create a fresh entry for today
  updatedLog[today] = {
    total,
    items: { ...soldItems }
  };
}

// Save both main and backup so they stay synced
localStorage.setItem("revenueLog", JSON.stringify(updatedLog));
localStorage.setItem("revenueLog_backup", JSON.stringify(updatedLog));


  // --- Clear all orders and backups properly ---
  localStorage.setItem("orders", JSON.stringify([]));         
  localStorage.setItem("orders_backup", JSON.stringify([]));  
  

  // Refresh dashboard displays
  loadOrders();
  loadRevenue();
  loadReviews();

  alert(`Recorded ៛${total.toLocaleString()} for ${today}. Orders cleared and stock reset.`);
});



// --- Load Revenue ---
function loadRevenue() {
  const revenueLog = safeParse(localStorage.getItem("revenueLog"), {});
  const tbody = document.querySelector("#revenueTable tbody");
  tbody.innerHTML = "";

  if (!Object.keys(revenueLog).length) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No revenue recorded yet.</td></tr>';
    return;
  }

  Object.entries(revenueLog).forEach(([date, data]) => {
    const tr = document.createElement("tr");

    // Sort items alphabetically for cleaner display
    const sortedItems = Object.entries(data.items || {}).sort((a, b) =>
      a[0].localeCompare(b[0])
    );

    // Make each item appear on its own line
    const itemsSold = sortedItems
      .map(([item, qty]) => `<div style="margin-bottom:3px;">• ${item}: <strong>${qty}</strong></div>`)
      .join("") || "—";

    tr.innerHTML = `
      <td>${date}</td>
      <td>៛${(data.total || 0).toLocaleString()}</td>
      <td>${itemsSold}</td>
      <td><button class="action-btn" onclick="deleteRevenue('${date}')">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function deleteRevenue(date) {
  if (!confirm(`Delete revenue record for ${date}?`)) return;
  const log = safeParse(localStorage.getItem("revenueLog"), {});
  delete log[date];
  localStorage.setItem("revenueLog", JSON.stringify(log));
  loadRevenue();
}

// --- Reviews ---
function loadReviews() {
  const reviews = safeParse(localStorage.getItem("reviews"), []);
  const list = document.getElementById("reviewsList");
  const count = document.getElementById("reviewCount");
  list.innerHTML = "";

  if (!reviews.length) {
    list.innerHTML = "<p>No reviews yet.</p>";
    count.textContent = 0;
    return;
  }

  count.textContent = reviews.length;
  reviews.forEach((rev, i) => {
    const div = document.createElement("div");
    div.classList.add("review");
    div.innerHTML = `
      <strong>${i + 1}. ⭐ ${rev.rating || "N/A"}/5</strong>
      <p>${rev.comment || ""}</p>
      <button onclick="deleteReview(${i})">Delete</button>
    `;
    list.appendChild(div);
  });
}

function deleteReview(i) {
  const reviews = safeParse(localStorage.getItem("reviews"), []);
  if (!confirm("Delete this review?")) return;
  reviews.splice(i, 1);
  localStorage.setItem("reviews", JSON.stringify(reviews));
  loadReviews();
}

// --- Back Button ---
document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "index.html";
});

// --- Restore Local Backup if Empty ---
function restoreDataFromBackup() {
  const revenue = localStorage.getItem("revenueLog");
  const revenueBackup = localStorage.getItem("revenueLog_backup");
  if (!revenue && revenueBackup) {
    localStorage.setItem("revenueLog", revenueBackup);
  }

  // Restore orders if missing 
  const orders = localStorage.getItem("orders");
  const ordersBackup = localStorage.getItem("orders_backup");
  if (!orders && ordersBackup) {
    localStorage.setItem("orders", ordersBackup);
  }

  // Restore reviews if missing 
  const reviews = localStorage.getItem("reviews");
  const reviewsBackup = localStorage.getItem("reviews_backup");
  if (!reviews && reviewsBackup) {
    localStorage.setItem("reviews", reviewsBackup);
  }
}

// --- Manual Reset Stock Button  ---
document.getElementById("resetStockBtn").addEventListener("click", () => {
  if (!confirm("Are you sure you want to reset all stock to 20 each?")) return;

  const newStock = {
    "French Crepe": 20,
    "Buchimgae": 20
  };

  // Persist stock and backup
  localStorage.setItem("stock", JSON.stringify(newStock));
  localStorage.setItem("stock_backup", JSON.stringify(newStock));

  // Also write a timestamp key so other pages can detect the update in any case
  localStorage.setItem("stock_update_ts", Date.now().toString());

  // Broadcast to other open tabs/windows using BroadcastChannel for instant update
  try {
    const bc = new BroadcastChannel('crepe_channel');
    bc.postMessage({ type: 'stock_update', stock: newStock, ts: Date.now() });
    bc.close();
  } catch (err) {
    // BroadcastChannel may not be supported in very old browsers — ignore safely
    console.warn('BroadcastChannel not available:', err);
  }

  alert("Stock successfully reset to 20 each!");
});


// --- Auto Refresh ---
setInterval(() => {
  loadOrders();
  loadReviews();
  loadRevenue();
}, 2000);

// --- Auto Refresh ---
setInterval(() => {
  loadOrders();
  loadReviews();
  loadRevenue();
}, 2000);

// --- Initial Load ---
restoreDataFromBackup();
loadOrders();
loadRevenue();
loadReviews();

// --- Auto Backup Before Leaving ---
window.addEventListener("beforeunload", () => {
  const revenue = localStorage.getItem("revenueLog");
  const orders = localStorage.getItem("orders");
  const reviews = localStorage.getItem("reviews");

  if (revenue) localStorage.setItem("revenueLog_backup", revenue);
  if (orders) localStorage.setItem("orders_backup", orders);
  if (reviews) localStorage.setItem("reviews_backup", reviews);
});

//  Fix: Instantly refresh menu when stock is reset in dashboard
window.addEventListener("storage", (e) => {
  if (e.key === "stock_update_ts") {
    try {
      const latestStock = JSON.parse(localStorage.getItem("stock"));
      if (latestStock && typeof latestStock === "object") {
        stock = latestStock;
        localStorage.setItem("stock", JSON.stringify(stock));
        if (typeof updateStockDisplay === "function") updateStockDisplay();
      }
    } catch (err) {
      console.warn("Error applying reset stock:", err);
    }
  }
});
</script>
</body>
</html>



